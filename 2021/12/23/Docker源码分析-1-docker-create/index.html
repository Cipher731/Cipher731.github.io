<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="0. 前言这篇文章将会分析执行docker create ubuntu以后，到底发生了哪些事情 1. Docker CLI（docker&#x2F;cli）最先发生的是解析命令行命令，并且做进一步的处理的操作。相关的代码位于docker&#x2F;cli仓库，并不在moby&#x2F;moby项目中。 docker使用了cobra作为CLI的框架，代码设计时NewXXXCommand用于注册相关命令 1234567891011">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker源码分析 - 1 - docker create">
<meta property="og:url" content="https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/index.html">
<meta property="og:site_name" content="Cipher731&#39;s Blog">
<meta property="og:description" content="0. 前言这篇文章将会分析执行docker create ubuntu以后，到底发生了哪些事情 1. Docker CLI（docker&#x2F;cli）最先发生的是解析命令行命令，并且做进一步的处理的操作。相关的代码位于docker&#x2F;cli仓库，并不在moby&#x2F;moby项目中。 docker使用了cobra作为CLI的框架，代码设计时NewXXXCommand用于注册相关命令 1234567891011">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-12-23T07:56:30.000Z">
<meta property="article:modified_time" content="2022-06-22T08:29:54.856Z">
<meta property="article:author" content="Cipher731">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Code Audit">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Docker源码分析 - 1 - docker create</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
    <!-- Google Analytics -->
    
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-199728190-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-199728190-1');
        </script>
    
    <!-- Baidu Analytics -->
    
        <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?93db9d043a30530833d0f8e65e1833a3";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post " href="/2021/10/28/Goland%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AEmoby%E3%80%81containerd%E5%92%8Crunc/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&text=Docker源码分析 - 1 - docker create"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&is_video=false&description=Docker源码分析 - 1 - docker create"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker源码分析 - 1 - docker create&body=Check out this article: https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&name=Docker源码分析 - 1 - docker create&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&t=Docker源码分析 - 1 - docker create"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0. 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Docker-CLI%EF%BC%88docker-cli%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">1. Docker CLI（docker&#x2F;cli）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Docker-daemon%EF%BC%88docker-docker%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">2. Docker daemon（docker&#x2F;docker）</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Docker源码分析 - 1 - docker create
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Cipher731</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-12-23T07:56:30.000Z" itemprop="datePublished">2021-12-23</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Docker-Audit/">Docker Audit</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Cloud-Native/" rel="tag">Cloud Native</a>, <a class="tag-link-link" href="/tags/Code-Audit/" rel="tag">Code Audit</a>, <a class="tag-link-link" href="/tags/Docker/" rel="tag">Docker</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h2><p>这篇文章将会分析执行<code>docker create ubuntu</code>以后，到底发生了哪些事情</p>
<h2 id="1-Docker-CLI（docker-cli）"><a href="#1-Docker-CLI（docker-cli）" class="headerlink" title="1. Docker CLI（docker/cli）"></a>1. Docker CLI（docker/cli）</h2><p>最先发生的是解析命令行命令，并且做进一步的处理的操作。<br>相关的代码位于<a target="_blank" rel="noopener" href="https://github.com/docker/cli">docker/cli</a>仓库，并不在moby/moby项目中。</p>
<p>docker使用了cobra作为CLI的框架，代码设计时<code>NewXXXCommand</code>用于注册相关命令</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:43</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewCreateCommand creates a new cobra.Command for `docker create`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCreateCommand</span><span class="params">(dockerCli command.Cli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> opts createOptions</span><br><span class="line">    <span class="keyword">var</span> copts *containerOptions</span><br><span class="line"></span><br><span class="line">    cmd := &amp;cobra.Command&#123;</span><br><span class="line">        Use:   <span class="string">&quot;create [OPTIONS] IMAGE [COMMAND] [ARG...]&quot;</span>,</span><br><span class="line">        Short: <span class="string">&quot;Create a new container&quot;</span>,</span><br><span class="line">        Args:  cli.RequiresMinArgs(<span class="number">1</span>),</span><br><span class="line">        RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">            copts.Image = args[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">                copts.Args = args[<span class="number">1</span>:]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> runCreate(dockerCli, cmd.Flags(), &amp;opts, copts)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数被传入<code>runCreate</code>执行，<code>runXXX</code>很显然用于执行相关命令</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:77</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runCreate</span><span class="params">(dockerCli command.Cli, flags *pflag.FlagSet, options *createOptions, copts *containerOptions)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    proxyConfig := dockerCli.ConfigFile().ParseProxyConfig(dockerCli.Client().DaemonHost(), opts.ConvertKVStringsToMapWithNil(copts.env.GetAll()))</span><br><span class="line">    newEnv := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> proxyConfig &#123;</span><br><span class="line">        <span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">            newEnv = <span class="built_in">append</span>(newEnv, k)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            newEnv = <span class="built_in">append</span>(newEnv, fmt.Sprintf(<span class="string">&quot;%s=%s&quot;</span>, k, *v))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    copts.env = *opts.NewListOptsRef(&amp;newEnv, <span class="literal">nil</span>)</span><br><span class="line">    containerConfig, err := parse(flags, copts, dockerCli.ServerInfo().OSType)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        reportError(dockerCli.Err(), <span class="string">&quot;create&quot;</span>, err.Error(), <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> cli.StatusError&#123;StatusCode: <span class="number">125</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = validateAPIVersion(containerConfig, dockerCli.Client().ClientVersion()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        reportError(dockerCli.Err(), <span class="string">&quot;create&quot;</span>, err.Error(), <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> cli.StatusError&#123;StatusCode: <span class="number">125</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response, err := createContainer(context.Background(), dockerCli, containerConfig, options)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Fprintln(dockerCli.Out(), response.ID)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是对参数进行了解析，生成了容器的所有配置，其实是属于OCI中runtime-spec规定的config格式。<br>parse的代码非常多，所以如果有需要再回来看parse代码。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/opts.go:303</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> containerConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Config           *container.Config</span><br><span class="line">    HostConfig       *container.HostConfig</span><br><span class="line">    NetworkingConfig *networktypes.NetworkingConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的containerConfig由Config、HostConfig和NetworkingConfig三者组成</p>
<details>
<summary>containerConfig的组成部分</summary>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/github.com/docker/docker/api/types/container/config.go:37</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Config contains the configuration data about a container.</span></span><br><span class="line"><span class="comment">// It should hold only portable information about the container.</span></span><br><span class="line"><span class="comment">// Here, &quot;portable&quot; means &quot;independent from the host we are running on&quot;.</span></span><br><span class="line"><span class="comment">// Non-portable information *should* appear in HostConfig.</span></span><br><span class="line"><span class="comment">// All fields added to this struct must be marked `omitempty` to keep getting</span></span><br><span class="line"><span class="comment">// predictable hashes from the old `v1Compatibility` configuration.</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    Hostname        <span class="keyword">string</span>              <span class="comment">// Hostname</span></span><br><span class="line">    Domainname      <span class="keyword">string</span>              <span class="comment">// Domainname</span></span><br><span class="line">    User            <span class="keyword">string</span>              <span class="comment">// User that will run the command(s) inside the container, also support user:group</span></span><br><span class="line">    AttachStdin     <span class="keyword">bool</span>                <span class="comment">// Attach the standard input, makes possible user interaction</span></span><br><span class="line">    AttachStdout    <span class="keyword">bool</span>                <span class="comment">// Attach the standard output</span></span><br><span class="line">    AttachStderr    <span class="keyword">bool</span>                <span class="comment">// Attach the standard error</span></span><br><span class="line">    ExposedPorts    nat.PortSet         <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// List of exposed ports</span></span><br><span class="line">    Tty             <span class="keyword">bool</span>                <span class="comment">// Attach standard streams to a tty, including stdin if it is not closed.</span></span><br><span class="line">    OpenStdin       <span class="keyword">bool</span>                <span class="comment">// Open stdin</span></span><br><span class="line">    StdinOnce       <span class="keyword">bool</span>                <span class="comment">// If true, close stdin after the 1 attached client disconnects.</span></span><br><span class="line">    Env             []<span class="keyword">string</span>            <span class="comment">// List of environment variable to set in the container</span></span><br><span class="line">    Cmd             strslice.StrSlice   <span class="comment">// Command to run when starting the container</span></span><br><span class="line">    Healthcheck     *HealthConfig       <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Healthcheck describes how to check the container is healthy</span></span><br><span class="line">    ArgsEscaped     <span class="keyword">bool</span>                <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// True if command is already escaped (meaning treat as a command line) (Windows specific).</span></span><br><span class="line">    Image           <span class="keyword">string</span>              <span class="comment">// Name of the image as it was passed by the operator (e.g. could be symbolic)</span></span><br><span class="line">    Volumes         <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// List of volumes (mounts) used for the container</span></span><br><span class="line">    WorkingDir      <span class="keyword">string</span>              <span class="comment">// Current directory (PWD) in the command will be launched</span></span><br><span class="line">    Entrypoint      strslice.StrSlice   <span class="comment">// Entrypoint to run when starting the container</span></span><br><span class="line">    NetworkDisabled <span class="keyword">bool</span>                <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Is network disabled</span></span><br><span class="line">    MacAddress      <span class="keyword">string</span>              <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Mac Address of the container</span></span><br><span class="line">    OnBuild         []<span class="keyword">string</span>            <span class="comment">// ONBUILD metadata that were defined on the image Dockerfile</span></span><br><span class="line">    Labels          <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>   <span class="comment">// List of labels set to this container</span></span><br><span class="line">    StopSignal      <span class="keyword">string</span>              <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Signal to stop a container</span></span><br><span class="line">    StopTimeout     *<span class="keyword">int</span>                <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Timeout (in seconds) to stop a container</span></span><br><span class="line">    Shell           strslice.StrSlice   <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Shell for shell-form of RUN, CMD, ENTRYPOINT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/github.com/docker/docker/api/types/container/host_config.go:391</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HostConfig the non-portable Config structure of a container.</span></span><br><span class="line"><span class="comment">// Here, &quot;non-portable&quot; means &quot;dependent of the host we are running on&quot;.</span></span><br><span class="line"><span class="comment">// Portable information *should* appear in Config.</span></span><br><span class="line"><span class="keyword">type</span> HostConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Applicable to all platforms</span></span><br><span class="line">    Binds           []<span class="keyword">string</span>      <span class="comment">// List of volume bindings for this container</span></span><br><span class="line">    ContainerIDFile <span class="keyword">string</span>        <span class="comment">// File (path) where the containerId is written</span></span><br><span class="line">    LogConfig       LogConfig     <span class="comment">// Configuration of the logs for this container</span></span><br><span class="line">    NetworkMode     NetworkMode   <span class="comment">// Network mode to use for the container</span></span><br><span class="line">    PortBindings    nat.PortMap   <span class="comment">// Port mapping between the exposed port (container) and the host</span></span><br><span class="line">    RestartPolicy   RestartPolicy <span class="comment">// Restart policy to be used for the container</span></span><br><span class="line">    AutoRemove      <span class="keyword">bool</span>          <span class="comment">// Automatically remove container when it exits</span></span><br><span class="line">    VolumeDriver    <span class="keyword">string</span>        <span class="comment">// Name of the volume driver used to mount volumes</span></span><br><span class="line">    VolumesFrom     []<span class="keyword">string</span>      <span class="comment">// List of volumes to take from other container</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applicable to UNIX platforms</span></span><br><span class="line">    CapAdd          strslice.StrSlice <span class="comment">// List of kernel capabilities to add to the container</span></span><br><span class="line">    CapDrop         strslice.StrSlice <span class="comment">// List of kernel capabilities to remove from the container</span></span><br><span class="line">    CgroupnsMode    CgroupnsMode      <span class="comment">// Cgroup namespace mode to use for the container</span></span><br><span class="line">    DNS             []<span class="keyword">string</span>          <span class="string">`json:&quot;Dns&quot;`</span>        <span class="comment">// List of DNS server to lookup</span></span><br><span class="line">    DNSOptions      []<span class="keyword">string</span>          <span class="string">`json:&quot;DnsOptions&quot;`</span> <span class="comment">// List of DNSOption to look for</span></span><br><span class="line">    DNSSearch       []<span class="keyword">string</span>          <span class="string">`json:&quot;DnsSearch&quot;`</span>  <span class="comment">// List of DNSSearch to look for</span></span><br><span class="line">    ExtraHosts      []<span class="keyword">string</span>          <span class="comment">// List of extra hosts</span></span><br><span class="line">    GroupAdd        []<span class="keyword">string</span>          <span class="comment">// List of additional groups that the container process will run as</span></span><br><span class="line">    IpcMode         IpcMode           <span class="comment">// IPC namespace to use for the container</span></span><br><span class="line">    Cgroup          CgroupSpec        <span class="comment">// Cgroup to use for the container</span></span><br><span class="line">    Links           []<span class="keyword">string</span>          <span class="comment">// List of links (in the name:alias form)</span></span><br><span class="line">    OomScoreAdj     <span class="keyword">int</span>               <span class="comment">// Container preference for OOM-killing</span></span><br><span class="line">    PidMode         PidMode           <span class="comment">// PID namespace to use for the container</span></span><br><span class="line">    Privileged      <span class="keyword">bool</span>              <span class="comment">// Is the container in privileged mode</span></span><br><span class="line">    PublishAllPorts <span class="keyword">bool</span>              <span class="comment">// Should docker publish all exposed port for the container</span></span><br><span class="line">    ReadonlyRootfs  <span class="keyword">bool</span>              <span class="comment">// Is the container root filesystem in read-only</span></span><br><span class="line">    SecurityOpt     []<span class="keyword">string</span>          <span class="comment">// List of string values to customize labels for MLS systems, such as SELinux.</span></span><br><span class="line">    StorageOpt      <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Storage driver options per container.</span></span><br><span class="line">    Tmpfs           <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// List of tmpfs (mounts) used for the container</span></span><br><span class="line">    UTSMode         UTSMode           <span class="comment">// UTS namespace to use for the container</span></span><br><span class="line">    UsernsMode      UsernsMode        <span class="comment">// The user namespace to use for the container</span></span><br><span class="line">    ShmSize         <span class="keyword">int64</span>             <span class="comment">// Total shm memory usage</span></span><br><span class="line">    Sysctls         <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// List of Namespaced sysctls used for the container</span></span><br><span class="line">    Runtime         <span class="keyword">string</span>            <span class="string">`json:&quot;,omitempty&quot;`</span> <span class="comment">// Runtime to use with this container</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applicable to Windows</span></span><br><span class="line">    ConsoleSize [<span class="number">2</span>]<span class="keyword">uint</span>   <span class="comment">// Initial console size (height,width)</span></span><br><span class="line">    Isolation   Isolation <span class="comment">// Isolation technology of the container (e.g. default, hyperv)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Contains container&#x27;s resources (cgroups, ulimits)</span></span><br><span class="line">    Resources</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mounts specs used by the container</span></span><br><span class="line">    Mounts []mount.Mount <span class="string">`json:&quot;,omitempty&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// MaskedPaths is the list of paths to be masked inside the container (this overrides the default set of paths)</span></span><br><span class="line">    MaskedPaths []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ReadonlyPaths is the list of paths to be set as read-only inside the container (this overrides the default set of paths)</span></span><br><span class="line">    ReadonlyPaths []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run a custom init inside the container, if null, use the daemon&#x27;s configured settings</span></span><br><span class="line">    Init *<span class="keyword">bool</span> <span class="string">`json:&quot;,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/github.com/docker/docker/api/types/network/network.go:102</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NetworkingConfig represents the container&#x27;s networking configuration for each of its interfaces</span></span><br><span class="line"><span class="comment">// Carries the networking configs specified in the `docker run` and `docker network connect` commands</span></span><br><span class="line"><span class="keyword">type</span> NetworkingConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    EndpointsConfig <span class="keyword">map</span>[<span class="keyword">string</span>]*EndpointSettings <span class="comment">// Endpoint configs for each connecting network</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// vendor/github.com/docker/docker/api/types/network/network.go:48</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// EndpointSettings stores the network endpoint details</span></span><br><span class="line"><span class="keyword">type</span> EndpointSettings <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Configurations</span></span><br><span class="line">    IPAMConfig *EndpointIPAMConfig</span><br><span class="line">    Links      []<span class="keyword">string</span></span><br><span class="line">    Aliases    []<span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Operational data</span></span><br><span class="line">    NetworkID           <span class="keyword">string</span></span><br><span class="line">    EndpointID          <span class="keyword">string</span></span><br><span class="line">    Gateway             <span class="keyword">string</span></span><br><span class="line">    IPAddress           <span class="keyword">string</span></span><br><span class="line">    IPPrefixLen         <span class="keyword">int</span></span><br><span class="line">    IPv6Gateway         <span class="keyword">string</span></span><br><span class="line">    GlobalIPv6Address   <span class="keyword">string</span></span><br><span class="line">    GlobalIPv6PrefixLen <span class="keyword">int</span></span><br><span class="line">    MacAddress          <span class="keyword">string</span></span><br><span class="line">    DriverOpts          <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:77</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runCreate</span><span class="params">(dockerCli command.Cli, flags *pflag.FlagSet, options *createOptions, copts *containerOptions)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    copts.env = *opts.NewListOptsRef(&amp;newEnv, <span class="literal">nil</span>)</span><br><span class="line">    containerConfig, err := parse(flags, copts, dockerCli.ServerInfo().OSType)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        reportError(dockerCli.Err(), <span class="string">&quot;create&quot;</span>, err.Error(), <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> cli.StatusError&#123;StatusCode: <span class="number">125</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = validateAPIVersion(containerConfig, dockerCli.Client().ClientVersion()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        reportError(dockerCli.Err(), <span class="string">&quot;create&quot;</span>, err.Error(), <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> cli.StatusError&#123;StatusCode: <span class="number">125</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response, err := createContainer(context.Background(), dockerCli, containerConfig, options)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Fprintln(dockerCli.Out(), response.ID)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details>

<p>成功解析参数完成之后经过API版本校验就执行createContainer操作</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    config := containerConfig.Config</span><br><span class="line">    hostConfig := containerConfig.HostConfig</span><br><span class="line">    networkingConfig := containerConfig.NetworkingConfig</span><br><span class="line">    stderr := dockerCli.Err()</span><br><span class="line"></span><br><span class="line">    warnOnOomKillDisable(*hostConfig, stderr)</span><br><span class="line">    warnOnLocalhostDNS(*hostConfig, stderr)</span><br></pre></td></tr></table></figure>
<p>首先重新从containerConfig中拆出了Config、HostConfig和NetworkingConfig，因为调用dockerd API的时候需要分离的这三个参数。<br>两个warn分别用于提醒禁用OOM Killer和本地地址DNS的配置，代码如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:285</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">warnOnOomKillDisable</span><span class="params">(hostConfig container.HostConfig, stderr io.Writer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> hostConfig.OomKillDisable != <span class="literal">nil</span> &amp;&amp; *hostConfig.OomKillDisable &amp;&amp; hostConfig.Memory == <span class="number">0</span> &#123;</span><br><span class="line">        fmt.Fprintln(stderr, <span class="string">&quot;WARNING: Disabling the OOM killer on containers without setting a &#x27;-m/--memory&#x27; limit may be dangerous.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check the DNS settings passed via --dns against localhost regexp to warn if</span></span><br><span class="line"><span class="comment">// they are trying to set a DNS to a localhost address</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">warnOnLocalhostDNS</span><span class="params">(hostConfig container.HostConfig, stderr io.Writer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, dnsIP := <span class="keyword">range</span> hostConfig.DNS &#123;</span><br><span class="line">        <span class="keyword">if</span> isLocalhost(dnsIP) &#123;</span><br><span class="line">            fmt.Fprintf(stderr, <span class="string">&quot;WARNING: Localhost DNS setting (--dns=%s) may fail in containers.\n&quot;</span>, dnsIP)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>警告的原因分别是：</p>
<ul>
<li>OOM Killer禁用并且未设置memory上限的情况下，容器可能占用过多内存影响主机OS性能甚至崩溃</li>
<li>本地地址上的DNS服务器在容器内不会正常工作</li>
</ul>
<p>继续看createContainer</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    containerIDFile, err := newCIDFile(hostConfig.ContainerIDFile)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> containerIDFile.Close()</span><br></pre></td></tr></table></figure>
<p>这边执行了CIDFile相关的操作，操作本身并不复杂，只是校验hostConfig中的ContainerIDFile是否创建成功了，但是关于这个文件此前并没有关注过。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContainerIDFile <span class="keyword">string</span>        <span class="comment">// File (path) where the containerId is written</span></span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:175</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCIDFile</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="params">(*cidFile, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;cidFile&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> _, err := os.Stat(path); err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;Container ID file found, make sure the other container isn&#x27;t running or delete %s&quot;</span>, path)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    f, err := os.Create(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;Failed to create the container ID file: %s&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;cidFile&#123;path: path, file: f&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据hostConfig中的注释和newCIDFile的逻辑，ContainerIDFile的功能有点类似PIDFile，似乎用于记录容器的ID（在当前只创建了一个文件）</p>
<p>继续看createContainer</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        trustedRef reference.Canonical</span><br><span class="line">        namedRef   reference.Named</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    ref, err := reference.ParseAnyReference(config.Image)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> named, ok := ref.(reference.Named); ok &#123;</span><br><span class="line">        namedRef = reference.TagNameOnly(named)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> taggedRef, ok := namedRef.(reference.NamedTagged); ok &amp;&amp; !opts.untrusted &#123;</span><br><span class="line">            <span class="keyword">var</span> err error</span><br><span class="line">            trustedRef, err = image.TrustedReference(ctx, dockerCli, taggedRef, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            config.Image = reference.FamiliarString(trustedRef)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>这段代码的作用是对传入的镜像名称进行解析，得到一个<code>TrustedReference</code>，类型是<code>reference.Canonical</code>，是由域名、镜像名和摘要组成的足以完全确定镜像的名称。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Canonical reference is an object with a fully unique</span></span><br><span class="line"><span class="comment">// name including a name with domain and digest</span></span><br><span class="line"><span class="keyword">type</span> Canonical <span class="keyword">interface</span> &#123;</span><br><span class="line">    Named</span><br><span class="line">    Digest() digest.Digest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反过来<code>TrustedReference</code>可以转换成：</p>
<ul>
<li><code>normalized name</code>，是形如<code>docker.io/library/ubuntu</code>的名称</li>
<li><code>familiar name</code>，是形如<code>ubuntu</code>的最简名称</li>
</ul>
<p>还有最后一步准备工作，校验CLI版本是否支持<code>platform</code>参数，只有<code>1.41</code>版本以上才支持，用于在支持多平台的主机上指定具体平台，包括不同的CPU指令集架构和OS类型</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">var</span> platform *specs.Platform</span><br><span class="line">    <span class="comment">// Engine API version 1.41 first introduced the option to specify platform on</span></span><br><span class="line">    <span class="comment">// create. It will produce an error if you try to set a platform on older API</span></span><br><span class="line">    <span class="comment">// versions, so check the API version here to maintain backwards</span></span><br><span class="line">    <span class="comment">// compatibility for CLI users.</span></span><br><span class="line">    <span class="keyword">if</span> opts.platform != <span class="string">&quot;&quot;</span> &amp;&amp; versions.GreaterThanOrEqualTo(dockerCli.Client().ClientVersion(), <span class="string">&quot;1.41&quot;</span>) &#123;</span><br><span class="line">        p, err := platforms.Parse(opts.platform)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;error parsing specified platform&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        platform = &amp;p</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>下面就是需要向dockerd发请求的部分了，首先是对设置了<code>PullImageAlways</code>的容器配置做处理，会直接先拖取镜像。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pullAndTagImage := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := pullImage(ctx, dockerCli, config.Image, opts.platform, stderr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> taggedRef, ok := namedRef.(reference.NamedTagged); ok &amp;&amp; trustedRef != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> image.TagTrusted(ctx, dockerCli, trustedRef, taggedRef)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> opts.pull == PullImageAlways &#123;</span><br><span class="line">        <span class="keyword">if</span> err := pullAndTagImage(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>pullAndTagImage封装了拖取镜像的逻辑，会调用<code>pullImage</code>函数</p>
<details>
<summary>pullImage函数分析</summary>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:105</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pullImage</span><span class="params">(ctx context.Context, dockerCli command.Cli, image <span class="keyword">string</span>, platform <span class="keyword">string</span>, out io.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ref, err := reference.ParseNormalizedNamed(image)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the Repository name from fqn to RepositoryInfo</span></span><br><span class="line">    repoInfo, err := registry.ParseRepositoryInfo(ref)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    authConfig := command.ResolveAuthConfig(ctx, dockerCli, repoInfo.Index)</span><br><span class="line">    encodedAuth, err := command.EncodeAuthToBase64(authConfig)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    options := types.ImageCreateOptions&#123;</span><br><span class="line">        RegistryAuth: encodedAuth,</span><br><span class="line">        Platform:     platform,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    responseBody, err := dockerCli.Client().ImageCreate(ctx, image, options)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> responseBody.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonmessage.DisplayJSONMessagesStream(</span><br><span class="line">        responseBody,</span><br><span class="line">        out,</span><br><span class="line">        dockerCli.Out().FD(),</span><br><span class="line">        dockerCli.Out().IsTerminal(),</span><br><span class="line">        <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查了镜像仓库之后调用Client的ImageCreate向daemon发送请求，通过vendor的方式使用了docker/docker项目中的client</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/github.com/docker/docker/client/image_create.go:13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ImageCreate creates a new image based on the parent options.</span></span><br><span class="line"><span class="comment">// It returns the JSON content in the response body.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">ImageCreate</span><span class="params">(ctx context.Context, parentReference <span class="keyword">string</span>, options types.ImageCreateOptions)</span> <span class="params">(io.ReadCloser, error)</span></span> &#123;</span><br><span class="line">    ref, err := reference.ParseNormalizedNamed(parentReference)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query := url.Values&#123;&#125;</span><br><span class="line">    query.Set(<span class="string">&quot;fromImage&quot;</span>, reference.FamiliarName(ref))</span><br><span class="line">    query.Set(<span class="string">&quot;tag&quot;</span>, getAPITagFromNamedRef(ref))</span><br><span class="line">    <span class="keyword">if</span> options.Platform != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        query.Set(<span class="string">&quot;platform&quot;</span>, strings.ToLower(options.Platform))</span><br><span class="line">    &#125;</span><br><span class="line">    resp, err := cli.tryImageCreate(ctx, query, options.RegistryAuth)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resp.body, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">tryImageCreate</span><span class="params">(ctx context.Context, query url.Values, registryAuth <span class="keyword">string</span>)</span> <span class="params">(serverResponse, error)</span></span> &#123;</span><br><span class="line">    headers := <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;<span class="string">&quot;X-Registry-Auth&quot;</span>: &#123;registryAuth&#125;&#125;</span><br><span class="line">    <span class="keyword">return</span> cli.post(ctx, <span class="string">&quot;/images/create&quot;</span>, query, <span class="literal">nil</span>, headers)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</details>

<p>回到<code>createContainer</code>函数的逻辑中，会直接调用一次Client的<code>ContainerCreate</code>，如果服务端返回镜像不存在并且容器配置了拖取策略是<code>PullImageMissing</code>，会进行一次拖取镜像的逻辑。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cli/command/container/create.go:192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, dockerCli command.Cli, containerConfig *containerConfig, opts *createOptions)</span> <span class="params">(*container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    response, err := dockerCli.Client().ContainerCreate(ctx, config, hostConfig, networkingConfig, platform, opts.name)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// Pull image if it does not exist locally and we have the PullImageMissing option. Default behavior.</span></span><br><span class="line">        <span class="keyword">if</span> apiclient.IsErrNotFound(err) &amp;&amp; namedRef != <span class="literal">nil</span> &amp;&amp; opts.pull == PullImageMissing &#123;</span><br><span class="line">            <span class="comment">// we don&#x27;t want to write to stdout anything apart from container.ID</span></span><br><span class="line">            fmt.Fprintf(stderr, <span class="string">&quot;Unable to find image &#x27;%s&#x27; locally\n&quot;</span>, reference.FamiliarString(namedRef))</span><br><span class="line">            <span class="keyword">if</span> err := pullAndTagImage(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> retryErr error</span><br><span class="line">            response, retryErr = dockerCli.Client().ContainerCreate(ctx, config, hostConfig, networkingConfig, platform, opts.name)</span><br><span class="line">            <span class="keyword">if</span> retryErr != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, retryErr</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, warning := <span class="keyword">range</span> response.Warnings &#123;</span><br><span class="line">        fmt.Fprintf(stderr, <span class="string">&quot;WARNING: %s\n&quot;</span>, warning)</span><br><span class="line">    &#125;</span><br><span class="line">    err = containerIDFile.Write(response.ID)</span><br><span class="line">    <span class="keyword">return</span> &amp;response, err</span><br></pre></td></tr></table></figure>

<p>Client的<code>ContainerCreate</code>，通过vendor的方式使用了docker/docker项目中的client</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/github.com/docker/docker/client/container_create.go:62</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ContainerCreate creates a new container based on the given configuration.</span></span><br><span class="line"><span class="comment">// It can be associated with a name, but it&#x27;s not mandatory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">ContainerCreate</span><span class="params">(ctx context.Context, config *container.Config, hostConfig *container.HostConfig, networkingConfig *network.NetworkingConfig, platform *specs.Platform, containerName <span class="keyword">string</span>)</span> <span class="params">(container.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> response container.ContainerCreateCreatedBody</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := cli.NewVersionError(<span class="string">&quot;1.25&quot;</span>, <span class="string">&quot;stop timeout&quot;</span>); config != <span class="literal">nil</span> &amp;&amp; config.StopTimeout != <span class="literal">nil</span> &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When using API 1.24 and under, the client is responsible for removing the container</span></span><br><span class="line">    <span class="keyword">if</span> hostConfig != <span class="literal">nil</span> &amp;&amp; versions.LessThan(cli.ClientVersion(), <span class="string">&quot;1.25&quot;</span>) &#123;</span><br><span class="line">        hostConfig.AutoRemove = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := cli.NewVersionError(<span class="string">&quot;1.41&quot;</span>, <span class="string">&quot;specify container image platform&quot;</span>); platform != <span class="literal">nil</span> &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query := url.Values&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> p := formatPlatform(platform); p != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        query.Set(<span class="string">&quot;platform&quot;</span>, p)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> containerName != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        query.Set(<span class="string">&quot;name&quot;</span>, containerName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    body := configWrapper&#123;</span><br><span class="line">        Config:           config,</span><br><span class="line">        HostConfig:       hostConfig,</span><br><span class="line">        NetworkingConfig: networkingConfig,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverResp, err := cli.post(ctx, <span class="string">&quot;/containers/create&quot;</span>, query, body, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">defer</span> ensureReaderClosed(serverResp)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = json.NewDecoder(serverResp.body).Decode(&amp;response)</span><br><span class="line">    <span class="keyword">return</span> response, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-Docker-daemon（docker-docker）"><a href="#2-Docker-daemon（docker-docker）" class="headerlink" title="2. Docker daemon（docker/docker）"></a>2. Docker daemon（docker/docker）</h2><p>Server注册的路由，注册了<code>&quot;/containers/create&quot;</code>，使用<code>postContainersCreate</code>进行处理。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/server/router/container/container.go:72</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// initRoutes initializes the routes in container router</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *containerRouter)</span> <span class="title">initRoutes</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r.routes = []router.Route&#123;</span><br><span class="line">        <span class="comment">// HEAD</span></span><br><span class="line">        router.NewHeadRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/archive&quot;</span>, r.headContainersArchive),</span><br><span class="line">        <span class="comment">// GET</span></span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/json&quot;</span>, r.getContainersJSON),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/export&quot;</span>, r.getContainersExport),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/changes&quot;</span>, r.getContainersChanges),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/json&quot;</span>, r.getContainersByName),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/top&quot;</span>, r.getContainersTop),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/logs&quot;</span>, r.getContainersLogs),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/stats&quot;</span>, r.getContainersStats),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/attach/ws&quot;</span>, r.wsContainersAttach),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/exec/&#123;id:.*&#125;/json&quot;</span>, r.getExecByID),</span><br><span class="line">        router.NewGetRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/archive&quot;</span>, r.getContainersArchive),</span><br><span class="line">        <span class="comment">// POST</span></span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/create&quot;</span>, r.postContainersCreate),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/kill&quot;</span>, r.postContainersKill),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/pause&quot;</span>, r.postContainersPause),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/unpause&quot;</span>, r.postContainersUnpause),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/restart&quot;</span>, r.postContainersRestart),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/start&quot;</span>, r.postContainersStart),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/stop&quot;</span>, r.postContainersStop),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/wait&quot;</span>, r.postContainersWait),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/resize&quot;</span>, r.postContainersResize),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/attach&quot;</span>, r.postContainersAttach),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/copy&quot;</span>, r.postContainersCopy), <span class="comment">// Deprecated since 1.8, Errors out since 1.12</span></span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/exec&quot;</span>, r.postContainerExecCreate),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/exec/&#123;name:.*&#125;/start&quot;</span>, r.postContainerExecStart),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/exec/&#123;name:.*&#125;/resize&quot;</span>, r.postContainerExecResize),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/rename&quot;</span>, r.postContainerRename),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/update&quot;</span>, r.postContainerUpdate),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/containers/prune&quot;</span>, r.postContainersPrune),</span><br><span class="line">        router.NewPostRoute(<span class="string">&quot;/commit&quot;</span>, r.postCommit),</span><br><span class="line">        <span class="comment">// PUT</span></span><br><span class="line">        router.NewPutRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;/archive&quot;</span>, r.putContainersArchive),</span><br><span class="line">        <span class="comment">// DELETE</span></span><br><span class="line">        router.NewDeleteRoute(<span class="string">&quot;/containers/&#123;name:.*&#125;&quot;</span>, r.deleteContainers),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>postContainersCreate</code>的实现</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/server/router/container/container_routes.go:460</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *containerRouter)</span> <span class="title">postContainersCreate</span><span class="params">(ctx context.Context, w http.ResponseWriter, r *http.Request, vars <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := httputils.ParseForm(r); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := httputils.CheckForJSON(r); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name := r.Form.Get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"></span><br><span class="line">    config, hostConfig, networkingConfig, err := s.decoder.DecodeConfig(r.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    version := httputils.VersionFromContext(ctx)</span><br><span class="line">    adjustCPUShares := versions.LessThan(version, <span class="string">&quot;1.19&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When using API 1.24 and under, the client is responsible for removing the container</span></span><br><span class="line">    <span class="keyword">if</span> hostConfig != <span class="literal">nil</span> &amp;&amp; versions.LessThan(version, <span class="string">&quot;1.25&quot;</span>) &#123;</span><br><span class="line">        hostConfig.AutoRemove = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hostConfig != <span class="literal">nil</span> &amp;&amp; versions.LessThan(version, <span class="string">&quot;1.40&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// Ignore BindOptions.NonRecursive because it was added in API 1.40.</span></span><br><span class="line">        <span class="keyword">for</span> _, m := <span class="keyword">range</span> hostConfig.Mounts &#123;</span><br><span class="line">            <span class="keyword">if</span> bo := m.BindOptions; bo != <span class="literal">nil</span> &#123;</span><br><span class="line">                bo.NonRecursive = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Ignore KernelMemoryTCP because it was added in API 1.40.</span></span><br><span class="line">        hostConfig.KernelMemoryTCP = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Older clients (API &lt; 1.40) expects the default to be shareable, make them happy</span></span><br><span class="line">        <span class="keyword">if</span> hostConfig.IpcMode.IsEmpty() &#123;</span><br><span class="line">            hostConfig.IpcMode = container.IPCModeShareable</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> hostConfig != <span class="literal">nil</span> &amp;&amp; versions.LessThan(version, <span class="string">&quot;1.41&quot;</span>) &amp;&amp; !s.cgroup2 &#123;</span><br><span class="line">        <span class="comment">// Older clients expect the default to be &quot;host&quot; on cgroup v1 hosts</span></span><br><span class="line">        <span class="keyword">if</span> hostConfig.CgroupnsMode.IsEmpty() &#123;</span><br><span class="line">            hostConfig.CgroupnsMode = container.CgroupnsModeHost</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> platform *specs.Platform</span><br><span class="line">    <span class="keyword">if</span> versions.GreaterThanOrEqualTo(version, <span class="string">&quot;1.41&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> v := r.Form.Get(<span class="string">&quot;platform&quot;</span>); v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            p, err := platforms.Parse(v)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> errdefs.InvalidParameter(err)</span><br><span class="line">            &#125;</span><br><span class="line">            platform = &amp;p</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hostConfig != <span class="literal">nil</span> &amp;&amp; hostConfig.PidsLimit != <span class="literal">nil</span> &amp;&amp; *hostConfig.PidsLimit &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t set a limit if either no limit was specified, or &quot;unlimited&quot; was</span></span><br><span class="line">        <span class="comment">// explicitly set.</span></span><br><span class="line">        <span class="comment">// Both `0` and `-1` are accepted as &quot;unlimited&quot;, and historically any</span></span><br><span class="line">        <span class="comment">// negative value was accepted, so treat those as &quot;unlimited&quot; as well.</span></span><br><span class="line">        hostConfig.PidsLimit = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ccr, err := s.backend.ContainerCreate(types.ContainerCreateConfig&#123;</span><br><span class="line">        Name:             name,</span><br><span class="line">        Config:           config,</span><br><span class="line">        HostConfig:       hostConfig,</span><br><span class="line">        NetworkingConfig: networkingConfig,</span><br><span class="line">        AdjustCPUShares:  adjustCPUShares,</span><br><span class="line">        Platform:         platform,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> httputils.WriteJSON(w, http.StatusCreated, ccr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中主要对版本不支持的参数进行了处理，之后调用<code>backend.ContainerCreate</code>进行实际的容器创建操作</p>
<details>
<summary>backend的定义</summary>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/server/router/container/backend.go:1</span></span><br><span class="line"><span class="keyword">package</span> container <span class="comment">// import &quot;github.com/docker/docker/api/server/router/container&quot;</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/docker/docker/api/types/backend&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/docker/docker/api/types/container&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/docker/docker/api/types/filters&quot;</span></span><br><span class="line">    containerpkg <span class="string">&quot;github.com/docker/docker/container&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/docker/docker/pkg/archive&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// execBackend includes functions to implement to provide exec functionality.</span></span><br><span class="line"><span class="keyword">type</span> execBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainerExecCreate(name <span class="keyword">string</span>, config *types.ExecConfig) (<span class="keyword">string</span>, error)</span><br><span class="line">    ContainerExecInspect(id <span class="keyword">string</span>) (*backend.ExecInspect, error)</span><br><span class="line">    ContainerExecResize(name <span class="keyword">string</span>, height, width <span class="keyword">int</span>) error</span><br><span class="line">    ContainerExecStart(ctx context.Context, name <span class="keyword">string</span>, stdin io.Reader, stdout io.Writer, stderr io.Writer) error</span><br><span class="line">    ExecExists(name <span class="keyword">string</span>) (<span class="keyword">bool</span>, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// copyBackend includes functions to implement to provide container copy functionality.</span></span><br><span class="line"><span class="keyword">type</span> copyBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainerArchivePath(name <span class="keyword">string</span>, path <span class="keyword">string</span>) (content io.ReadCloser, stat *types.ContainerPathStat, err error)</span><br><span class="line">    ContainerCopy(name <span class="keyword">string</span>, res <span class="keyword">string</span>) (io.ReadCloser, error)</span><br><span class="line">    ContainerExport(name <span class="keyword">string</span>, out io.Writer) error</span><br><span class="line">    ContainerExtractToDir(name, path <span class="keyword">string</span>, copyUIDGID, noOverwriteDirNonDir <span class="keyword">bool</span>, content io.Reader) error</span><br><span class="line">    ContainerStatPath(name <span class="keyword">string</span>, path <span class="keyword">string</span>) (stat *types.ContainerPathStat, err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stateBackend includes functions to implement to provide container state lifecycle functionality.</span></span><br><span class="line"><span class="keyword">type</span> stateBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainerCreate(config types.ContainerCreateConfig) (container.ContainerCreateCreatedBody, error)</span><br><span class="line">    ContainerKill(name <span class="keyword">string</span>, sig <span class="keyword">uint64</span>) error</span><br><span class="line">    ContainerPause(name <span class="keyword">string</span>) error</span><br><span class="line">    ContainerRename(oldName, newName <span class="keyword">string</span>) error</span><br><span class="line">    ContainerResize(name <span class="keyword">string</span>, height, width <span class="keyword">int</span>) error</span><br><span class="line">    ContainerRestart(name <span class="keyword">string</span>, seconds *<span class="keyword">int</span>) error</span><br><span class="line">    ContainerRm(name <span class="keyword">string</span>, config *types.ContainerRmConfig) error</span><br><span class="line">    ContainerStart(name <span class="keyword">string</span>, hostConfig *container.HostConfig, checkpoint <span class="keyword">string</span>, checkpointDir <span class="keyword">string</span>) error</span><br><span class="line">    ContainerStop(name <span class="keyword">string</span>, seconds *<span class="keyword">int</span>) error</span><br><span class="line">    ContainerUnpause(name <span class="keyword">string</span>) error</span><br><span class="line">    ContainerUpdate(name <span class="keyword">string</span>, hostConfig *container.HostConfig) (container.ContainerUpdateOKBody, error)</span><br><span class="line">    ContainerWait(ctx context.Context, name <span class="keyword">string</span>, condition containerpkg.WaitCondition) (&lt;-<span class="keyword">chan</span> containerpkg.StateStatus, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// monitorBackend includes functions to implement to provide containers monitoring functionality.</span></span><br><span class="line"><span class="keyword">type</span> monitorBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainerChanges(name <span class="keyword">string</span>) ([]archive.Change, error)</span><br><span class="line">    ContainerInspect(name <span class="keyword">string</span>, size <span class="keyword">bool</span>, version <span class="keyword">string</span>) (<span class="keyword">interface</span>&#123;&#125;, error)</span><br><span class="line">    ContainerLogs(ctx context.Context, name <span class="keyword">string</span>, config *types.ContainerLogsOptions) (msgs &lt;-<span class="keyword">chan</span> *backend.LogMessage, tty <span class="keyword">bool</span>, err error)</span><br><span class="line">    ContainerStats(ctx context.Context, name <span class="keyword">string</span>, config *backend.ContainerStatsConfig) error</span><br><span class="line">    ContainerTop(name <span class="keyword">string</span>, psArgs <span class="keyword">string</span>) (*container.ContainerTopOKBody, error)</span><br><span class="line"></span><br><span class="line">    Containers(config *types.ContainerListOptions) ([]*types.Container, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attachBackend includes function to implement to provide container attaching functionality.</span></span><br><span class="line"><span class="keyword">type</span> attachBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainerAttach(name <span class="keyword">string</span>, c *backend.ContainerAttachConfig) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// systemBackend includes functions to implement to provide system wide containers functionality</span></span><br><span class="line"><span class="keyword">type</span> systemBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    ContainersPrune(ctx context.Context, pruneFilters filters.Args) (*types.ContainersPruneReport, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> commitBackend <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateImageFromContainer(name <span class="keyword">string</span>, config *backend.CreateImageConfig) (imageID <span class="keyword">string</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Backend is all the methods that need to be implemented to provide container specific functionality.</span></span><br><span class="line"><span class="keyword">type</span> Backend <span class="keyword">interface</span> &#123;</span><br><span class="line">    commitBackend</span><br><span class="line">    execBackend</span><br><span class="line">    copyBackend</span><br><span class="line">    stateBackend</span><br><span class="line">    monitorBackend</span><br><span class="line">    attachBackend</span><br><span class="line">    systemBackend</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details>
daemon就是实现了Backend接口的一个类型，`ContainerCreate`公开方法会调用`containerCreate`私有方法。
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// daemon/create.go:41</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ContainerCreate creates a regular container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">ContainerCreate</span><span class="params">(params types.ContainerCreateConfig)</span> <span class="params">(containertypes.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> daemon.containerCreate(createOpts&#123;</span><br><span class="line">        params:                  params,</span><br><span class="line">        managed:                 <span class="literal">false</span>,</span><br><span class="line">        ignoreImagesArgsEscaped: <span class="literal">false</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
下面是containerCreate的具体实现
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(daemon *Daemon)</span> <span class="title">containerCreate</span><span class="params">(opts createOpts)</span> <span class="params">(containertypes.ContainerCreateCreatedBody, error)</span></span> &#123;</span><br><span class="line">    start := time.Now()</span><br><span class="line">    <span class="keyword">if</span> opts.params.Config == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;&#125;, errdefs.InvalidParameter(errors.New(<span class="string">&quot;Config cannot be empty in order to create a container&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    warnings, err := daemon.verifyContainerSettings(opts.params.HostConfig, opts.params.Config, <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;Warnings: warnings&#125;, errdefs.InvalidParameter(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opts.params.Platform == <span class="literal">nil</span> &amp;&amp; opts.params.Config.Image != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> img, _ := daemon.imageService.GetImage(opts.params.Config.Image, opts.params.Platform); img != <span class="literal">nil</span> &#123;</span><br><span class="line">            p := platforms.DefaultSpec()</span><br><span class="line">            imgPlat := v1.Platform&#123;</span><br><span class="line">                OS:           img.OS,</span><br><span class="line">                Architecture: img.Architecture,</span><br><span class="line">                Variant:      img.Variant,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> !images.OnlyPlatformWithFallback(p).Match(imgPlat) &#123;</span><br><span class="line">                warnings = <span class="built_in">append</span>(warnings, fmt.Sprintf(<span class="string">&quot;The requested image&#x27;s platform (%s) does not match the detected host platform (%s) and no specific platform was requested&quot;</span>, platforms.Format(imgPlat), platforms.Format(p)))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = verifyNetworkingConfig(opts.params.NetworkingConfig)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;Warnings: warnings&#125;, errdefs.InvalidParameter(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opts.params.HostConfig == <span class="literal">nil</span> &#123;</span><br><span class="line">        opts.params.HostConfig = &amp;containertypes.HostConfig&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    err = daemon.adaptContainerSettings(opts.params.HostConfig, opts.params.AdjustCPUShares)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;Warnings: warnings&#125;, errdefs.InvalidParameter(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctr, err := daemon.create(opts)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;Warnings: warnings&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line">    containerActions.WithValues(<span class="string">&quot;create&quot;</span>).UpdateSince(start)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> warnings == <span class="literal">nil</span> &#123;</span><br><span class="line">        warnings = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>) <span class="comment">// Create an empty slice to avoid https://github.com/moby/moby/issues/38222</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> containertypes.ContainerCreateCreatedBody&#123;ID: ctr.ID, Warnings: warnings&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里就涉及到大量的检查和操作了，后续再继续展开。
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0. 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Docker-CLI%EF%BC%88docker-cli%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">1. Docker CLI（docker&#x2F;cli）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Docker-daemon%EF%BC%88docker-docker%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">2. Docker daemon（docker&#x2F;docker）</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&text=Docker源码分析 - 1 - docker create"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&is_video=false&description=Docker源码分析 - 1 - docker create"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker源码分析 - 1 - docker create&body=Check out this article: https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&title=Docker源码分析 - 1 - docker create"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&name=Docker源码分析 - 1 - docker create&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://cipher731.github.io/2021/12/23/Docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-docker-create/&t=Docker源码分析 - 1 - docker create"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2022
    Cipher731
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
